<html>
<head>

<style>

	html, body { width:100%; height:100%; padding: 0; margin: 0; font-family: Tahoma; background: #272822}
	
	h1 { color: white; background: #272822; padding: 10px 10px 0px 10px; background #84ff00; margin:10;
        background-image:url(bcl.png);
        background-repeat: no-repeat;
        background-position: 20px 8px;
        background-size: 180px;
        padding-left: 220px;
    }
    
	pre { }
	
	div.edit {margin:10px;}
	
	div.console {color: white; height: 180px; overflow:auto; margin: 10px; border: 1px solid black; padding: 10px;}
	#code { display:none }
	
	#editor { 
        width: 100%;
		height: 500px;
    }
    
    iframe#post {display:none;}
    
    #ide
    {
        float:left;
        width: 100%;
    }
    
    #panel
    {
        float:right;
        width:50%;
        height:100%;
        display:none;
    }
    
    #panel iframe 
    {
        width:100%;
        height:100%;
        border: 0;
    }
    
    #examples
    {
        color:white;
    }
    
    a { color: white }

</style>

<title>Compiler - BigClown</title>


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/default.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>


<script src="/socket.io/socket.io.js"></script>
<script>
  var socket = io();
  var socketId = null;
  
  var panelIsDisplayed = false;
  var panelType = "";

  function formSubmit()
  {
	// Clear console
	document.getElementById("console").innerHTML = "";
	
	// Copy data from editor
	document.getElementById("code").value = editor.getValue();
    
    // Copy socket id
    document.getElementById("socketId").value = socketId;
  }
  
  function panelToggle()
  {
    panelIsDisplayed = !panelIsDisplayed;
    
    panelDisplay(panelIsDisplayed);
  }
  
  function panelDisplay()
  {
    if(panelType != null)
    {
        document.getElementById("panel").style.display = "block";
        document.getElementById("ide").style.width = "50%"; //bad, very bad
    }
    else
    {
        document.getElementById("panel").style.display = "none";
        document.getElementById("ide").style.width = "100%"; //bad, very bad
    }
  }
  
  function loadApi()
  {
    if(panelType != "api")
    {
        panelType = "api";
        panelDisplay();
        document.getElementById("api").src = "http://api.bigclown.com";
    } else {
        panelType = null;
        panelDisplay();
    }
  }
  
  function loadExamples()
  {
    if(panelType != "examples")
    {
        panelType = "examples";
        panelDisplay();
        document.getElementById("api").src = "examples";
    } else {
        panelType = null;
        panelDisplay();
    }
  }
  
  function consolePrint(msg)
  {
    // Append message
    var div = document.getElementById("console");
    var content = document.createTextNode(msg + "\n");
    div.appendChild(content);

    // Scroll console to the view
    var elem = document.getElementById('console_container');
    elem.scrollTop = elem.scrollHeight;
  }
  
  function loadExample(id)
  {
    socket.emit("loadExample", id);
  }
  
  // Socket on connect event
  socket.on('connect', function () {
  
    // Debug print of socket ID
    consolePrint("Connected to compile server (" + socket.io.engine.id+ ")");
    // Get socket ID to put it to the form during compilation
    socketId = socket.id;
   
  });
  
      // On incoming packet "msg" display text to the console
    socket.on('msg', function(msg){
      consolePrint(msg);
    });
    
    socket.on('example', function(code){
      // Set example to the editor, cursor at the begining (-1)
      editor.setValue(code, -1);
    });
  

</script>

</head>
<body>

<div id="ide">

    <h1>web compiler</h1>

    <div id = "editor" >
        #include &lt;application.h&gt;
        #include &lt;usb_talk.h&gt;
        #include &lt;bc_led.h&gt;
        #include &lt;bc_button.h&gt;
        bc_led_t led;
        bc_button_t button;

        void button_event_handler(bc_button_t *self, bc_button_event_t event, void *param)
        {
            (void) self;
            (void) param;
            if (event == BC_BUTTON_EVENT_PRESS)
            {
                static uint16_t event_count = 0;
                bc_led_set_mode(&led, (event_count & 1) != 0 ? BC_LED_MODE_BLINK : BC_LED_MODE_OFF);
                usb_talk_publish_push_button("", &event_count);
                event_count++;
            }
        }

        void application_init(void)
        {
            usb_talk_init();

            bc_led_init(&led, BC_GPIO_LED, false, false);
            bc_led_set_mode(&led, BC_LED_MODE_BLINK);

            bc_button_init(&button, BC_GPIO_BUTTON, BC_GPIO_PULL_DOWN, false);
            bc_button_set_event_handler(&button, button_event_handler, NULL);
        }

    </div>

    <iframe id="post" name="post"></iframe>

    <div class="edit">
    <form method="post" onsubmit="formSubmit()" target="post">
        <textarea id="code" name="code" >
        </textarea>
        <input type="hidden" id="socketId" name="socketId" />

        <input type="submit" value="Compile"/>
        <input type = "button" onclick="loadApi()" value="API Help" />
        <input type = "button" onclick="loadExamples()" value="Examples" />
        
    </form>
    </div>

    <div class="console" id="console_container">
        <pre id="console">
        </pre>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.6/ace.js"></script>
    <script>
        var editor = ace.edit("editor");
        editor.setTheme("ace/theme/monokai");
        editor.getSession().setMode("ace/mode/c_cpp");
    </script>
    
</div>

<div id="panel" >
    <iframe id="api" src="http://api.bigclown.com"></iframe>
    <div id="examples"></div>
</div>

</body>
</html>